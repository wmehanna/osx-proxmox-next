#!/usr/bin/env bash
set -euo pipefail

# â”€â”€â”€ AI Attribution Check (BLOCKING) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AI_PATTERNS=(
  'ðŸ¤–'
  'Generated with.*Claude'
  'Generated with.*Codex'
  'Co-Authored-By: Claude'
  'Co-Authored-By: Codex'
  'anthropic\.com'
  'noreply@anthropic'
  'openai\.com'
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null || true)
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

AI_REGEX=$(IFS='|'; echo "${AI_PATTERNS[*]}")

VIOLATIONS=""
while IFS= read -r file; do
  # Skip hook definition files (they contain the patterns as strings)
  if [[ "$file" == .githooks/* ]]; then continue; fi
  if [ -f "$file" ]; then
    MATCHES=$(git diff --cached -- "$file" | grep -iE "$AI_REGEX" || true)
    if [ -n "$MATCHES" ]; then
      VIOLATIONS="${VIOLATIONS}\n  âœ— ${file}:\n$(echo "$MATCHES" | head -3 | sed 's/^/      /')\n"
    fi
  fi
done <<< "$STAGED_FILES"

if [ -n "$VIOLATIONS" ]; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  BLOCKED: AI attribution detected in staged  â•‘"
  echo "â•‘  files. Remove before committing.            â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo -e "$VIOLATIONS"
  exit 1
fi

# â”€â”€â”€ Hardcoded Secrets Check (BLOCKING) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SECRET_PATTERNS='(password|passwd|api[_-]?key|secret[_-]?key|access[_-]?token|private[_-]?key)\s*[:=]\s*["\x27][^\s]{8,}'

SECRET_VIOLATIONS=""
while IFS= read -r file; do
  if [[ "$file" == .githooks/* ]]; then continue; fi
  if [ -f "$file" ]; then
    MATCHES=$(git diff --cached -- "$file" | grep -iE "$SECRET_PATTERNS" || true)
    if [ -n "$MATCHES" ]; then
      SECRET_VIOLATIONS="${SECRET_VIOLATIONS}\n  âœ— ${file}:\n$(echo "$MATCHES" | head -3 | sed 's/^/      /')\n"
    fi
  fi
done <<< "$STAGED_FILES"

if [ -n "$SECRET_VIOLATIONS" ]; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  BLOCKED: Possible hardcoded secrets found.  â•‘"
  echo "â•‘  Remove or use environment variables.        â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo -e "$SECRET_VIOLATIONS"
  exit 1
fi

# â”€â”€â”€ TODO/FIXME Warning (NON-BLOCKING) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TODO_FOUND=""
while IFS= read -r file; do
  if [ -f "$file" ]; then
    MATCHES=$(git diff --cached -- "$file" | grep -nE '^\+.*\b(TODO|FIXME|HACK|XXX)\b' || true)
    if [ -n "$MATCHES" ]; then
      TODO_FOUND="${TODO_FOUND}\n  âš  ${file}"
    fi
  fi
done <<< "$STAGED_FILES"

if [ -n "$TODO_FOUND" ]; then
  echo ""
  echo "âš  WARNING: TODO/FIXME comments found (non-blocking):"
  echo -e "$TODO_FOUND"
  echo ""
fi

# â”€â”€â”€ Debug Print Warning (NON-BLOCKING, .py only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PRINT_FOUND=""
while IFS= read -r file; do
  if [[ "$file" == *.py ]] && [ -f "$file" ]; then
    MATCHES=$(git diff --cached -- "$file" | grep -nE '^\+.*\bprint\(' || true)
    if [ -n "$MATCHES" ]; then
      PRINT_FOUND="${PRINT_FOUND}\n  âš  ${file}"
    fi
  fi
done <<< "$STAGED_FILES"

if [ -n "$PRINT_FOUND" ]; then
  echo ""
  echo "âš  WARNING: print() statements in Python files (non-blocking):"
  echo -e "$PRINT_FOUND"
  echo ""
fi

exit 0
