#!/usr/bin/env bash
set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# â”€â”€â”€ AI Attribution Check (BLOCKING) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AI_PATTERNS=(
  'ğŸ¤–'
  'Generated with.*Claude'
  'Generated with.*Codex'
  'Co-Authored-By: Claude'
  'Co-Authored-By: Codex'
  'anthropic\.com'
  'noreply@anthropic'
  'openai\.com'
)

AI_REGEX=$(IFS='|'; echo "${AI_PATTERNS[*]}")

if echo "$COMMIT_MSG" | grep -qiE "$AI_REGEX"; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  BLOCKED: AI attribution in commit message.  â•‘"
  echo "â•‘  Remove AI references before committing.     â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  echo "  Message: $(head -1 "$COMMIT_MSG_FILE")"
  exit 1
fi

# â”€â”€â”€ Conventional Commit Format (BLOCKING) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FIRST_LINE=$(head -1 "$COMMIT_MSG_FILE")

# Allow merge commits
if echo "$FIRST_LINE" | grep -qE '^Merge '; then
  exit 0
fi

CONVENTIONAL_REGEX='^(feat|fix|refactor|docs|test|chore|perf|ci)(\(.+\))?: .{1,}'

if ! echo "$FIRST_LINE" | grep -qE "$CONVENTIONAL_REGEX"; then
  echo ""
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  BLOCKED: Invalid commit message format.     â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  echo "  Expected: <type>(<scope>): <description>"
  echo "  Types:    feat|fix|refactor|docs|test|chore|perf|ci"
  echo ""
  echo "  Examples:"
  echo "    feat(wizard): add storage auto-detection"
  echo "    fix(planner): correct disk size calculation"
  echo "    docs: update README troubleshooting section"
  echo ""
  echo "  Got: $FIRST_LINE"
  exit 1
fi

exit 0
